import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from "@/components/ui/dialog";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Separator } from "@/components/ui/separator";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { 
  AlertTriangle, 
  Shield, 
  Info, 
  ExternalLink,
  Copy,
  Server,
  Clock,
  Bug,
  FileText,
  Wrench,
  Link2
} from "lucide-react";
import { useToast } from "@/hooks/use-toast";
import type { VulnerabilityWithContext, SeverityLevel, VulnStatus } from "@shared/schema";

interface VulnerabilityDetailsDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  vulnerability: VulnerabilityWithContext | null;
  onUpdateStatus: (id: string, status: VulnStatus) => void;
  onUpdateNotes: (id: string, notes: string) => void;
}

const SEVERITY_CONFIG: Record<SeverityLevel, { label: string; color: string; icon: typeof AlertTriangle; bgColor: string }> = {
  critical: { label: "Критический", color: "text-red-400", bgColor: "bg-red-500/20 border-red-500/30", icon: AlertTriangle },
  high: { label: "Высокий", color: "text-orange-400", bgColor: "bg-orange-500/20 border-orange-500/30", icon: AlertTriangle },
  medium: { label: "Средний", color: "text-yellow-400", bgColor: "bg-yellow-500/20 border-yellow-500/30", icon: Shield },
  low: { label: "Низкий", color: "text-blue-400", bgColor: "bg-blue-500/20 border-blue-500/30", icon: Info },
  info: { label: "Информация", color: "text-gray-400", bgColor: "bg-gray-500/20 border-gray-500/30", icon: Info },
};

export function VulnerabilityDetailsDialog({
  open,
  onOpenChange,
  vulnerability,
  onUpdateStatus,
  onUpdateNotes,
}: VulnerabilityDetailsDialogProps) {
  const { toast } = useToast();

  if (!vulnerability) return null;

  const severityConfig = SEVERITY_CONFIG[vulnerability.severity as SeverityLevel] || SEVERITY_CONFIG.info;
  const SeverityIcon = severityConfig.icon;

  const copyToClipboard = (text: string, label: string) => {
    navigator.clipboard.writeText(text);
    toast({ title: `${label} скопировано` });
  };

  const formatDate = (date: Date | string | null) => {
    if (!date) return "N/A";
    return new Date(date).toLocaleString("ru-RU");
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-3xl max-h-[90vh]">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-3">
            <div className={`p-2 rounded-md ${severityConfig.bgColor} border`}>
              <SeverityIcon className={`w-5 h-5 ${severityConfig.color}`} />
            </div>
            <div className="flex-1">
              <div className="text-lg font-semibold">{vulnerability.name}</div>
              <div className="flex items-center gap-2 mt-1">
                <Badge className={`${severityConfig.bgColor} ${severityConfig.color} border`}>
                  {severityConfig.label}
                </Badge>
                {vulnerability.cve && (
                  <Badge variant="outline" className="text-cyan-400 border-cyan-500/30">
                    {vulnerability.cve}
                  </Badge>
                )}
                {vulnerability.cvss && (
                  <Badge variant="outline" className="text-orange-400 border-orange-500/30">
                    CVSS: {vulnerability.cvss}
                  </Badge>
                )}
              </div>
            </div>
          </DialogTitle>
          <DialogDescription className="sr-only">
            Детальная информация об уязвимости, включая описание и рекомендации
          </DialogDescription>
        </DialogHeader>

        <ScrollArea className="max-h-[calc(90vh-200px)] pr-4">
          <div className="space-y-6">
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <div className="flex items-center gap-2 text-sm text-muted-foreground">
                  <Server className="w-4 h-4" />
                  Цель
                </div>
                <div className="p-3 rounded-md bg-muted/30 border border-border">
                  <div className="font-mono text-primary">
                    {vulnerability.host?.ipAddress || "N/A"}
                    {vulnerability.service && `:${vulnerability.service.port}`}
                  </div>
                  {vulnerability.service && (
                    <div className="text-sm text-muted-foreground">
                      {vulnerability.service.serviceName || "unknown"} ({vulnerability.service.protocol})
                    </div>
                  )}
                  {vulnerability.host?.os && (
                    <div className="text-sm text-muted-foreground mt-1">
                      OS: {vulnerability.host.os}
                    </div>
                  )}
                </div>
              </div>

              <div className="space-y-2">
                <div className="flex items-center gap-2 text-sm text-muted-foreground">
                  <Bug className="w-4 h-4" />
                  Детали
                </div>
                <div className="p-3 rounded-md bg-muted/30 border border-border space-y-1.5">
                  <div className="flex justify-between text-sm">
                    <span className="text-muted-foreground">Сканер:</span>
                    <Badge variant="outline">{vulnerability.scanner}</Badge>
                  </div>
                  {vulnerability.templateId && (
                    <div className="flex justify-between text-sm">
                      <span className="text-muted-foreground">Template:</span>
                      <span className="font-mono text-xs">{vulnerability.templateId}</span>
                    </div>
                  )}
                  {vulnerability.cwe && (
                    <div className="flex justify-between text-sm">
                      <span className="text-muted-foreground">CWE:</span>
                      <span>{vulnerability.cwe}</span>
                    </div>
                  )}
                </div>
              </div>
            </div>

            <Separator />

            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2 text-sm text-muted-foreground">
                <Clock className="w-4 h-4" />
                Обнаружено: {formatDate(vulnerability.discoveredAt)}
              </div>
              <div className="flex items-center gap-2">
                <span className="text-sm text-muted-foreground">Статус:</span>
                <Select 
                  value={vulnerability.status || "open"} 
                  onValueChange={(v) => onUpdateStatus(vulnerability.id, v as VulnStatus)}
                >
                  <SelectTrigger className="w-[150px]" data-testid="select-vuln-status">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="open">Открыта</SelectItem>
                    <SelectItem value="confirmed">Подтверждена</SelectItem>
                    <SelectItem value="false_positive">Ложная</SelectItem>
                    <SelectItem value="fixed">Исправлена</SelectItem>
                    <SelectItem value="accepted">Принята</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            {vulnerability.description && (
              <div className="space-y-2">
                <div className="flex items-center gap-2 text-sm font-medium">
                  <FileText className="w-4 h-4" />
                  Описание
                </div>
                <div className="p-3 rounded-md bg-muted/30 border border-border text-sm whitespace-pre-wrap">
                  {vulnerability.description}
                </div>
              </div>
            )}

            {vulnerability.solution && (
              <div className="space-y-2">
                <div className="flex items-center gap-2 text-sm font-medium text-green-400">
                  <Wrench className="w-4 h-4" />
                  Рекомендации по исправлению
                </div>
                <div className="p-3 rounded-md bg-green-500/10 border border-green-500/30 text-sm whitespace-pre-wrap">
                  {vulnerability.solution}
                </div>
              </div>
            )}

            {vulnerability.proof && (
              <div className="space-y-2">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2 text-sm font-medium text-orange-400">
                    <AlertTriangle className="w-4 h-4" />
                    Доказательство (Proof)
                  </div>
                  <Button 
                    variant="ghost" 
                    size="sm"
                    onClick={() => copyToClipboard(vulnerability.proof!, "Proof")}
                  >
                    <Copy className="w-3 h-3 mr-1" />
                    Копировать
                  </Button>
                </div>
                <div className="p-3 rounded-md bg-orange-500/10 border border-orange-500/30 font-mono text-xs whitespace-pre-wrap">
                  {vulnerability.proof}
                </div>
              </div>
            )}

            {vulnerability.matchedAt && (
              <div className="space-y-2">
                <div className="text-sm font-medium">Matched At</div>
                <div className="p-2 rounded-md bg-muted/30 border border-border font-mono text-xs break-all">
                  {vulnerability.matchedAt}
                </div>
              </div>
            )}

            {vulnerability.rawOutput && (
              <div className="space-y-2">
                <div className="flex items-center justify-between">
                  <div className="text-sm font-medium">Raw Output</div>
                  <Button 
                    variant="ghost" 
                    size="sm"
                    onClick={() => copyToClipboard(vulnerability.rawOutput!, "Output")}
                  >
                    <Copy className="w-3 h-3 mr-1" />
                    Копировать
                  </Button>
                </div>
                <ScrollArea className="h-40 rounded-md border border-border">
                  <pre className="p-3 text-xs font-mono bg-black/50 whitespace-pre-wrap">
                    {vulnerability.rawOutput}
                  </pre>
                </ScrollArea>
              </div>
            )}

            {vulnerability.references && vulnerability.references.length > 0 && (
              <div className="space-y-2">
                <div className="flex items-center gap-2 text-sm font-medium">
                  <Link2 className="w-4 h-4" />
                  Ссылки
                </div>
                <div className="space-y-1.5">
                  {vulnerability.references.map((ref, i) => (
                    <a
                      key={i}
                      href={ref}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex items-center gap-2 text-sm text-cyan-400 hover:underline"
                    >
                      <ExternalLink className="w-3 h-3" />
                      {ref}
                    </a>
                  ))}
                </div>
              </div>
            )}

            <div className="space-y-2">
              <div className="text-sm font-medium">Заметки</div>
              <Textarea
                placeholder="Добавьте заметки об этой уязвимости..."
                value={vulnerability.notes || ""}
                onChange={(e) => onUpdateNotes(vulnerability.id, e.target.value)}
                className="min-h-[80px] resize-none"
                data-testid="textarea-vuln-notes"
              />
            </div>

            {vulnerability.cve && (
              <div className="flex gap-2">
                <Button variant="outline" size="sm" asChild>
                  <a 
                    href={`https://nvd.nist.gov/vuln/detail/${vulnerability.cve}`}
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    <ExternalLink className="w-3 h-3 mr-1" />
                    NVD
                  </a>
                </Button>
                <Button variant="outline" size="sm" asChild>
                  <a 
                    href={`https://cve.mitre.org/cgi-bin/cvename.cgi?name=${vulnerability.cve}`}
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    <ExternalLink className="w-3 h-3 mr-1" />
                    MITRE
                  </a>
                </Button>
                <Button variant="outline" size="sm" asChild>
                  <a 
                    href={`https://www.exploit-db.com/search?cve=${vulnerability.cve.replace("CVE-", "")}`}
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    <ExternalLink className="w-3 h-3 mr-1" />
                    Exploit-DB
                  </a>
                </Button>
              </div>
            )}
          </div>
        </ScrollArea>
      </DialogContent>
    </Dialog>
  );
}
