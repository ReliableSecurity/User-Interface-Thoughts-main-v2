import { useState } from "react";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Badge } from "@/components/ui/badge";
import { AlertTriangle, Shield, Info, Calculator, Plus, X } from "lucide-react";
import type { Host, Service, SeverityLevel } from "@shared/schema";

interface CreateVulnerabilityDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  hosts: Host[];
  services: { hostId: string; service: Service }[];
  projectId: string;
  companyId: string;
  onSubmit: (data: VulnerabilityFormData) => void;
  isPending?: boolean;
}

export interface VulnerabilityFormData {
  projectId: string;
  companyId: string;
  hostId?: string;
  serviceId?: string;
  name: string;
  severity: SeverityLevel;
  cvss?: string;
  cve?: string;
  cwe?: string;
  description?: string;
  solution?: string;
  references?: string[];
  scanner: string;
  proof?: string;
}

const SEVERITY_OPTIONS: { value: SeverityLevel; label: string; color: string; icon: typeof AlertTriangle }[] = [
  { value: "critical", label: "Критический", color: "bg-red-500/20 text-red-400 border-red-500/30", icon: AlertTriangle },
  { value: "high", label: "Высокий", color: "bg-orange-500/20 text-orange-400 border-orange-500/30", icon: AlertTriangle },
  { value: "medium", label: "Средний", color: "bg-yellow-500/20 text-yellow-400 border-yellow-500/30", icon: Shield },
  { value: "low", label: "Низкий", color: "bg-blue-500/20 text-blue-400 border-blue-500/30", icon: Info },
  { value: "info", label: "Информация", color: "bg-gray-500/20 text-gray-400 border-gray-500/30", icon: Info },
];

const CVSS_METRICS = {
  AV: { name: "Attack Vector", options: [
    { value: "N", label: "Network", score: 0.85 },
    { value: "A", label: "Adjacent", score: 0.62 },
    { value: "L", label: "Local", score: 0.55 },
    { value: "P", label: "Physical", score: 0.2 },
  ]},
  AC: { name: "Attack Complexity", options: [
    { value: "L", label: "Low", score: 0.77 },
    { value: "H", label: "High", score: 0.44 },
  ]},
  PR: { name: "Privileges Required", options: [
    { value: "N", label: "None", score: 0.85 },
    { value: "L", label: "Low", score: 0.62 },
    { value: "H", label: "High", score: 0.27 },
  ]},
  UI: { name: "User Interaction", options: [
    { value: "N", label: "None", score: 0.85 },
    { value: "R", label: "Required", score: 0.62 },
  ]},
  S: { name: "Scope", options: [
    { value: "U", label: "Unchanged", score: 0 },
    { value: "C", label: "Changed", score: 1 },
  ]},
  C: { name: "Confidentiality", options: [
    { value: "N", label: "None", score: 0 },
    { value: "L", label: "Low", score: 0.22 },
    { value: "H", label: "High", score: 0.56 },
  ]},
  I: { name: "Integrity", options: [
    { value: "N", label: "None", score: 0 },
    { value: "L", label: "Low", score: 0.22 },
    { value: "H", label: "High", score: 0.56 },
  ]},
  A: { name: "Availability", options: [
    { value: "N", label: "None", score: 0 },
    { value: "L", label: "Low", score: 0.22 },
    { value: "H", label: "High", score: 0.56 },
  ]},
};

function calculateCVSS(metrics: Record<string, string>): { score: number; vector: string; severity: SeverityLevel } {
  const AV = CVSS_METRICS.AV.options.find(o => o.value === metrics.AV)?.score || 0;
  const AC = CVSS_METRICS.AC.options.find(o => o.value === metrics.AC)?.score || 0;
  const PR = CVSS_METRICS.PR.options.find(o => o.value === metrics.PR)?.score || 0;
  const UI = CVSS_METRICS.UI.options.find(o => o.value === metrics.UI)?.score || 0;
  const S = metrics.S === "C" ? 1 : 0;
  const C = CVSS_METRICS.C.options.find(o => o.value === metrics.C)?.score || 0;
  const I = CVSS_METRICS.I.options.find(o => o.value === metrics.I)?.score || 0;
  const A = CVSS_METRICS.A.options.find(o => o.value === metrics.A)?.score || 0;

  const ISS = 1 - ((1 - C) * (1 - I) * (1 - A));
  
  let impact: number;
  if (S === 0) {
    impact = 6.42 * ISS;
  } else {
    impact = 7.52 * (ISS - 0.029) - 3.25 * Math.pow(ISS - 0.02, 15);
  }

  const exploitability = 8.22 * AV * AC * PR * UI;
  
  let score: number;
  if (impact <= 0) {
    score = 0;
  } else if (S === 0) {
    score = Math.min(impact + exploitability, 10);
  } else {
    score = Math.min(1.08 * (impact + exploitability), 10);
  }

  score = Math.ceil(score * 10) / 10;

  const vector = `CVSS:3.1/AV:${metrics.AV}/AC:${metrics.AC}/PR:${metrics.PR}/UI:${metrics.UI}/S:${metrics.S}/C:${metrics.C}/I:${metrics.I}/A:${metrics.A}`;

  let severity: SeverityLevel;
  if (score === 0) severity = "info";
  else if (score < 4) severity = "low";
  else if (score < 7) severity = "medium";
  else if (score < 9) severity = "high";
  else severity = "critical";

  return { score, vector, severity };
}

export function CreateVulnerabilityDialog({
  open,
  onOpenChange,
  hosts,
  services,
  projectId,
  companyId,
  onSubmit,
  isPending,
}: CreateVulnerabilityDialogProps) {
  const [name, setName] = useState("");
  const [severity, setSeverity] = useState<SeverityLevel>("medium");
  const [cvss, setCvss] = useState("");
  const [cve, setCve] = useState("");
  const [cwe, setCwe] = useState("");
  const [description, setDescription] = useState("");
  const [solution, setSolution] = useState("");
  const [proof, setProof] = useState("");
  const [selectedHostId, setSelectedHostId] = useState<string>("");
  const [selectedServiceId, setSelectedServiceId] = useState<string>("");
  const [references, setReferences] = useState<string[]>([]);
  const [newReference, setNewReference] = useState("");
  
  const [cvssMetrics, setCvssMetrics] = useState<Record<string, string>>({
    AV: "N", AC: "L", PR: "N", UI: "N", S: "U", C: "H", I: "H", A: "H"
  });

  const cvssResult = calculateCVSS(cvssMetrics);

  const hostServices = selectedHostId 
    ? services.filter(s => s.hostId === selectedHostId).map(s => s.service)
    : [];

  const applyCVSS = () => {
    setCvss(cvssResult.score.toString());
    setSeverity(cvssResult.severity);
  };

  const addReference = () => {
    if (newReference.trim()) {
      setReferences([...references, newReference.trim()]);
      setNewReference("");
    }
  };

  const removeReference = (index: number) => {
    setReferences(references.filter((_, i) => i !== index));
  };

  const handleSubmit = () => {
    if (!name.trim()) return;

    onSubmit({
      projectId,
      companyId,
      hostId: selectedHostId || undefined,
      serviceId: selectedServiceId || undefined,
      name: name.trim(),
      severity,
      cvss: cvss || undefined,
      cve: cve || undefined,
      cwe: cwe || undefined,
      description: description || undefined,
      solution: solution || undefined,
      references: references.length > 0 ? references : undefined,
      scanner: "manual",
      proof: proof || undefined,
    });

    setName("");
    setSeverity("medium");
    setCvss("");
    setCve("");
    setCwe("");
    setDescription("");
    setSolution("");
    setProof("");
    setSelectedHostId("");
    setSelectedServiceId("");
    setReferences([]);
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <AlertTriangle className="w-5 h-5 text-red-400" />
            Добавить уязвимость
          </DialogTitle>
          <DialogDescription>
            Создайте новую запись об уязвимости вручную
          </DialogDescription>
        </DialogHeader>

        <Tabs defaultValue="basic" className="flex-1 overflow-hidden flex flex-col">
          <TabsList className="grid w-full grid-cols-3">
            <TabsTrigger value="basic" data-testid="tab-vuln-basic">Основное</TabsTrigger>
            <TabsTrigger value="cvss" data-testid="tab-vuln-cvss">CVSS Калькулятор</TabsTrigger>
            <TabsTrigger value="details" data-testid="tab-vuln-details">Детали</TabsTrigger>
          </TabsList>

          <div className="flex-1 overflow-auto mt-4">
            <TabsContent value="basic" className="space-y-4 m-0">
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="vuln-name">Название *</Label>
                  <Input
                    id="vuln-name"
                    placeholder="SQL Injection в форме логина"
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    data-testid="input-vuln-name"
                  />
                </div>

                <div className="space-y-2">
                  <Label>Критичность</Label>
                  <Select value={severity} onValueChange={(v) => setSeverity(v as SeverityLevel)}>
                    <SelectTrigger data-testid="select-vuln-severity">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {SEVERITY_OPTIONS.map((opt) => (
                        <SelectItem key={opt.value} value={opt.value}>
                          <div className="flex items-center gap-2">
                            <opt.icon className="w-4 h-4" />
                            {opt.label}
                          </div>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <div className="grid grid-cols-3 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="vuln-cvss">CVSS Score</Label>
                  <Input
                    id="vuln-cvss"
                    placeholder="9.8"
                    value={cvss}
                    onChange={(e) => setCvss(e.target.value)}
                    data-testid="input-vuln-cvss"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="vuln-cve">CVE ID</Label>
                  <Input
                    id="vuln-cve"
                    placeholder="CVE-2024-12345"
                    value={cve}
                    onChange={(e) => setCve(e.target.value)}
                    data-testid="input-vuln-cve"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="vuln-cwe">CWE ID</Label>
                  <Input
                    id="vuln-cwe"
                    placeholder="CWE-89"
                    value={cwe}
                    onChange={(e) => setCwe(e.target.value)}
                    data-testid="input-vuln-cwe"
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Хост</Label>
                  <Select value={selectedHostId} onValueChange={setSelectedHostId}>
                    <SelectTrigger data-testid="select-vuln-host">
                      <SelectValue placeholder="Выберите хост" />
                    </SelectTrigger>
                    <SelectContent>
                      {hosts.map((host) => (
                        <SelectItem key={host.id} value={host.id}>
                          {host.ipAddress} {(host.domain || host.hostname) && `(${host.domain || host.hostname})`}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Сервис</Label>
                  <Select 
                    value={selectedServiceId} 
                    onValueChange={setSelectedServiceId}
                    disabled={!selectedHostId}
                  >
                    <SelectTrigger data-testid="select-vuln-service">
                      <SelectValue placeholder="Выберите сервис" />
                    </SelectTrigger>
                    <SelectContent>
                      {hostServices.map((service) => (
                        <SelectItem key={service.id} value={service.id}>
                          {service.port}/{service.protocol} - {service.serviceName || "unknown"}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="vuln-description">Описание</Label>
                <Textarea
                  id="vuln-description"
                  placeholder="Подробное описание уязвимости..."
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                  className="min-h-[100px]"
                  data-testid="textarea-vuln-description"
                />
              </div>
            </TabsContent>

            <TabsContent value="cvss" className="space-y-4 m-0">
              <div className="p-4 rounded-lg bg-muted/30 border border-border">
                <div className="flex items-center justify-between mb-4">
                  <div className="flex items-center gap-2">
                    <Calculator className="w-5 h-5 text-cyan-400" />
                    <span className="font-medium">CVSS 3.1 Калькулятор</span>
                  </div>
                  <div className="flex items-center gap-3">
                    <div className="text-2xl font-bold text-primary">{cvssResult.score}</div>
                    <Badge className={SEVERITY_OPTIONS.find(s => s.value === cvssResult.severity)?.color}>
                      {SEVERITY_OPTIONS.find(s => s.value === cvssResult.severity)?.label}
                    </Badge>
                  </div>
                </div>

                <div className="text-xs font-mono text-muted-foreground mb-4 break-all">
                  {cvssResult.vector}
                </div>

                <Button size="sm" onClick={applyCVSS} data-testid="button-apply-cvss">
                  Применить к уязвимости
                </Button>
              </div>

              <div className="grid grid-cols-2 gap-4">
                {Object.entries(CVSS_METRICS).map(([key, metric]) => (
                  <div key={key} className="space-y-2">
                    <Label className="text-xs text-muted-foreground">{metric.name}</Label>
                    <div className="flex gap-1">
                      {metric.options.map((opt) => (
                        <Button
                          key={opt.value}
                          size="sm"
                          variant={cvssMetrics[key] === opt.value ? "default" : "outline"}
                          onClick={() => setCvssMetrics({ ...cvssMetrics, [key]: opt.value })}
                          className="flex-1 text-xs"
                          data-testid={`cvss-${key}-${opt.value}`}
                        >
                          {opt.label}
                        </Button>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            </TabsContent>

            <TabsContent value="details" className="space-y-4 m-0">
              <div className="space-y-2">
                <Label htmlFor="vuln-solution">Рекомендации по исправлению</Label>
                <Textarea
                  id="vuln-solution"
                  placeholder="Шаги для устранения уязвимости..."
                  value={solution}
                  onChange={(e) => setSolution(e.target.value)}
                  className="min-h-[100px]"
                  data-testid="textarea-vuln-solution"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="vuln-proof">Доказательство (Proof of Concept)</Label>
                <Textarea
                  id="vuln-proof"
                  placeholder="Шаги воспроизведения, пейлоад, скриншоты..."
                  value={proof}
                  onChange={(e) => setProof(e.target.value)}
                  className="min-h-[100px] font-mono text-sm"
                  data-testid="textarea-vuln-proof"
                />
              </div>

              <div className="space-y-2">
                <Label>Ссылки</Label>
                <div className="flex gap-2">
                  <Input
                    placeholder="https://example.com/advisory"
                    value={newReference}
                    onChange={(e) => setNewReference(e.target.value)}
                    onKeyDown={(e) => e.key === "Enter" && addReference()}
                    data-testid="input-vuln-reference"
                  />
                  <Button size="icon" onClick={addReference} data-testid="button-add-reference">
                    <Plus className="w-4 h-4" />
                  </Button>
                </div>
                {references.length > 0 && (
                  <div className="flex flex-wrap gap-2 mt-2">
                    {references.map((ref, i) => (
                      <Badge 
                        key={i} 
                        variant="outline" 
                        className="flex items-center gap-1 max-w-[300px]"
                      >
                        <span className="truncate">{ref}</span>
                        <button onClick={() => removeReference(i)} className="ml-1 hover:text-red-400">
                          <X className="w-3 h-3" />
                        </button>
                      </Badge>
                    ))}
                  </div>
                )}
              </div>
            </TabsContent>
          </div>
        </Tabs>

        <DialogFooter className="mt-4">
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            Отмена
          </Button>
          <Button 
            onClick={handleSubmit} 
            disabled={!name.trim() || isPending}
            data-testid="button-submit-vulnerability"
          >
            {isPending ? "Создание..." : "Создать уязвимость"}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
